{% extends 'base.html' %}
{% load static %}

{% block title %}{{ restaurant.name }} - MealMate{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/restaurant_detail.css' %}">
{% endblock %}

{% block content %}
<div class="restaurant-detail">
    <div class="restaurant-detail-header">
        <div class="restaurant-detail-image-section">
            {% if restaurant.image %}
                <img src="{{ restaurant.image.url }}" alt="{{ restaurant.name }}" class="restaurant-detail-image">
            {% else %}
                <div class="restaurant-detail-image-placeholder">
                    <span>No Image</span>
                </div>
            {% endif %}
        </div>
        <div class="restaurant-detail-info-section">
            <h1>{{ restaurant.name }}</h1>
            <div class="cuisine-badges">
                {% for cuisine in restaurant.cuisines.all %}
                    {% if forloop.counter <= 4 %}
                        <span class="cuisine-badge">{{ cuisine.name }}</span>
                    {% elif forloop.counter == 5 %}
                        <span class="cuisine-badge">+{{ restaurant.cuisines.count|add:"-4" }} more</span>
                    {% endif %}
                {% endfor %}
            </div>

            {% if can_edit %}
                <div class="action-buttons">
                    <a href="{% url 'main:update_restaurant' restaurant.id %}" class="btn btn-outline">Update Restaurant</a>
                    <a href="{% url 'main:delete_restaurant' restaurant.id %}" class="btn btn-danger">Delete Restaurant</a>
                    <a href="{% url 'main:add_dish' restaurant.id %}" class="btn btn-primary">Add Dish</a>
                </div>
            {% endif %}
        </div>
    </div>

    {% if restaurant.description %}
        <div class="restaurant-description">
            <p>{{ restaurant.description }}</p>
        </div>
    {% endif %}

    <div class="restaurant-info">
        <div class="info-item">
            <label>Opening Time</label>
            <p>{{ restaurant.opening_time }}</p>
        </div>
        <div class="info-item">
            <label>Closing Time</label>
            <p>{{ restaurant.closing_time }}</p>
        </div>
        <div class="info-item">
            <label>Owner</label>
            <p>{{ restaurant.owner.username }}</p>
        </div>
        <div class="info-item">
            <label>Total Dishes</label>
            <p>{{ dishes.count }}</p>
        </div>
    </div>

    {% if restaurant.iframe_location %}
        <div class="restaurant-map">
            {{ restaurant.iframe_location|safe }}
        </div>
    {% endif %}

    <!-- Rating Section -->
    <div class="restaurant-rating-section">
        <a href="{% url 'main:restaurant_reviews' restaurant.id %}" class="rating-link">
            <div class="rating-display">
                <div class="rating-stars" data-rating="{{ restaurant.get_average_rating|default:0 }}">
                    {% with avg_rating=restaurant.get_average_rating %}
                        {% if avg_rating %}
                            {% for i in "12345" %}
                                <span class="star" data-star="{{ forloop.counter }}">★</span>
                            {% endfor %}
                            <span class="rating-value">{{ avg_rating|floatformat:1 }} / 5</span>
                        {% else %}
                            {% for i in "12345" %}
                                <span class="star">★</span>
                            {% endfor %}
                            <span class="rating-value">No ratings yet</span>
                        {% endif %}
                    {% endwith %}
                </div>
                <div class="rating-count">
                    {% with count=restaurant.get_reviews_count %}
                        {% if count == 0 %}
                            <span class="no-reviews">Be the first to review!</span>
                        {% else %}
                            <span>{{ count }} review{{ count|pluralize }}</span>
                        {% endif %}
                    {% endwith %}
                </div>
            </div>
        </a>
        {% if user.is_authenticated %}
            {% if not restaurant.has_user_reviewed %}
                <a href="{% url 'main:create_review' restaurant.id %}" class="btn btn-primary btn-sm">Write a Review</a>
            {% else %}
                <a href="{% url 'main:create_review' restaurant.id %}" class="btn btn-outline btn-sm">Update Your Review</a>
            {% endif %}
        {% endif %}
    </div>
</div>

<div>
    <h2 class="menu-title">Menu</h2>

    {% if dishes %}
        <div class="dish-grid">
            {% for dish in dishes %}
                <div class="dish-card-wrapper">
                    <a href="{% url 'main:dish_detail' dish.id %}" class="dish-card-link">
                        <div class="dish-card">
                            {% if dish.image %}
                                <img src="{{ dish.image.url }}" alt="{{ dish.name }}" class="dish-image">
                            {% else %}
                                <div class="dish-image-placeholder">
                                    <span>No Image</span>
                                </div>
                            {% endif %}
                            <div class="dish-card-body">
                                <h3 class="truncate-text">{{ dish.name }}</h3>
                                <div class="dish-price">₹{{ dish.price }}</div>
                                {% if can_edit %}
                                    <div class="dish-actions">
                                        <a href="{% url 'main:update_dish' dish.id %}" class="btn btn-outline btn-sm">Update</a>
                                        <a href="{% url 'main:delete_dish' dish.id %}" class="btn btn-danger btn-sm">Delete</a>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </a>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="empty-state">
            <h3>No Dishes Yet</h3>
            <p>Start building your menu by adding dishes!</p>
            {% if can_edit %}
                <a href="{% url 'main:add_dish' restaurant.id %}" class="btn btn-primary">Add First Dish</a>
            {% endif %}
        </div>
    {% endif %}
</div>

<script>
// Update star display based on average rating
document.addEventListener('DOMContentLoaded', function() {
    const ratingStars = document.querySelector('.rating-stars[data-rating]');
    if (ratingStars) {
        const avgRating = parseFloat(ratingStars.getAttribute('data-rating'));
        if (avgRating > 0) {
            const stars = ratingStars.querySelectorAll('.star[data-star]');
            stars.forEach(star => {
                const starNum = parseInt(star.getAttribute('data-star'));
                star.classList.remove('filled', 'half');
                
                if (starNum <= Math.floor(avgRating)) {
                    // Fully filled star
                    star.classList.add('filled');
                } else if (starNum - 1 < avgRating && avgRating < starNum) {
                    // Half-filled star (e.g., rating is 3.5, starNum is 4)
                    star.classList.add('half');
                }
            });
        }
    }
});
</script>
{% endblock %}
